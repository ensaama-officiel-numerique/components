<!-- https://www.w3docs.com/snippets/javascript/how-to-create-and-trigger-event-in-javascript.html -->
<!-- https://devstephen.medium.com/keyboardevent-key-for-cross-browser-key-press-check-61dbad0a067a -->
<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <!-- <script src="https://ensaama-officiel-numerique.github.io/components/detect/detect.js"></script> -->
    <script src="https://ensaama-officiel-numerique.github.io/components/debug/debug.js"></script>
    <script src="./detect.js"></script> 
    <script>

    // HAND HEIGHT
    AFRAME.registerComponent('hand-height', {
        schema: {
            trace: {
                type: 'boolean',
                default: false
            },
            seuils: {
                type: 'array',
                default: [1]
            },
            state: {
                type: 'string',
                default: '0'
            },
            side: { type: 'string'}
        },
        tick: function () {
            // var cibles = this.data.cibles;
            let side = this.data.side;
            let seuils = this.data.seuils;
            let state = this.data.state;
            let hauteur;
            switch(side) {
                case 'left': hauteur = player.left.y; break;
                case 'right': hauteur = player.right.y; break;
                default: hauteur = (player.left.y + player.right.y)/2;
            }

            let newstate = 0;
            for (let i = 0; i < seuils.length; i++) {
                if (hauteur > seuils[i]) newstate = i + 1;
            }
            if (state != newstate) {
                if (state < newstate) {
                    this.el.emit(side+"up-" + newstate);
                    console.log("event : '"+side+"up-" + newstate + "' sent to #" + this.el.id);
                } else {
                    this.el.emit(side + "up-" + newstate);
                    console.log("event : '" + side +"down-" + newstate + "' sent to #" + this.el.id);
                }
                this.data.state = newstate;
            }
            if (this.data.trace) {
                var log = document.querySelector('#txtlog');
                log.setAttribute('value', "#" + this.el.id + " _ etat=" + newstate + " _ hauteur=" + hauteur.toFixed(2));
            }
        }
    });

    // composant pour visualier les changements de hauteur
    AFRAME.registerComponent('modify-color', {
        init: function () {
            let el = this.el;
            console.log(el.id);
            // Wait for event
            this.el.addEventListener('bothup-3', () => { el.setAttribute('color', 'red'); });
            this.el.addEventListener('bothup-2', () => { el.setAttribute('color', 'green'); });
            this.el.addEventListener('bothup-1', () => { el.setAttribute('color', 'blue'); });                                    
            this.el.addEventListener('bothdown-2', () => { el.setAttribute('color', 'green'); });
            this.el.addEventListener('bothdown-1', () => { el.setAttribute('color', 'blue'); }); 
            this.el.addEventListener('bothdown-0', () => { el.setAttribute('color', 'yellow'); });                                    
        }

    });    

    // composant pour tester avec les clavier (sans manette)
    AFRAME.registerComponent('change-height', {
        init: function () {
            let el = this.el;
            let key = ['h','b'];
            document.addEventListener('keypress', evt => {
                for (var i = 0; i < key.length; i++) {
                    if (evt.key === key[0]) {
                        console.log("key '"+key[0]+"' was pressed");
                        let position = el.getAttribute('position');
                        el.setAttribute("position", position.x+" "+(position.y + 0.1)+" "+position.z);
                    }
                    if (evt.keyCode === key[1].codePointAt(0)) {
                        console.log("key '" + key[1] + "' was pressed");
                        let position = el.getAttribute('position');
                        el.setAttribute("position", position.x + " " + (position.y - 0.1) + " " + position.z);
                    }                    
                }
            });
        }
    });

    </script>    
</head>

<body>

    <a-scene background="color: skyblue" frequency="delay: 500"
        debug-keyboard="key: r; event: droiteup-2; target: #boite;">

        <a-box id="boite" position="1 0 -2" rotation="0 45 0" color="silver"
            width="0.25" height="0.25" depth="0.25" 
            hand-height="trace: trace; side: both; seuils: 0.5, 1, 2"
            modify-color>
        </a-box>

        <a-plane position="0 0 -2" rotation="-90 0 0" width="4" height="4" color="gray">
        </a-plane>

        <!-- PLAYER -->
        <a-entity id="cameraRig">
        
            <!-- TETE -->
            <a-entity id="tete" camera position="0 0.5 0" currentposition handsposition
                look-controls wasd-controls="acceleration:10">
                <a-text id="txtlog" value="" align="center" color="#FF0000" position="0 0 -1" rotation="0 0 0"
                    scale="0.25 0.25 0.25">
                </a-text>
            </a-entity>
        
            <!-- MAIN GAUCHE : utiliser oculus-touch-controls pour model3D -->
            <a-entity id="gauche" hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc">
            </a-entity>
        
            <!-- MAIN DROITE : utiliser oculus-touch-controls pour model3D -->
            <a-entity id="droite" hand-controls="hand: right; handModelStyle: lowPoly; color: #ffcccc" change-height>
            </a-entity>
        
        </a-entity>

    </a-scene>

</body>

</html>